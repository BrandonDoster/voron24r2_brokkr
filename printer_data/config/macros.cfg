#####################################################################
#   A better print_start macro for v2/trident
#####################################################################
## https://github.com/jontek2/A-better-print_start-macro
## *** THINGS TO UNCOMMENT: ***
## Bed mesh (2 lines at 2 locations)
## Nevermore (if you have one)
## Z_TILT_ADJUST (For Trident only)
## QUAD_GANTRY_LEVEL (For V2.4 only)
## Beacon Contact logic (if you have one. 4 lines at 4 locations)

# [gcode_macro PRINT_START]
# gcode:
#   # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
#   {% set target_bed = params.BED|int %}
#   {% set target_extruder = params.EXTRUDER|int %}
#   {% set target_chamber = params.CHAMBER|default("45")|int %}
#   {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
#   {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

#   ##  Uncomment for Beacon Contact (1 of 4 for beacon contact)
#   #SET_GCODE_OFFSET Z=0                                 # Set offset to 0

#   # Clear any lingering pause states
#   CLEAR_PAUSE

#   # Home the printer, set absolute positioning and update the Stealthburner LEDs.
#   STATUS_HOMING                                         # Set LEDs to homing-mode
#   G28                                                   # Full home (XYZ)
#   G90                                                   # Absolute position

#   ##  Uncomment for bed mesh (1 of 2 for bed mesh)
#   BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

#   # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
#   # {% if params.BED|int > 90 %}
#   #   SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
#   #   STATUS_HEATING                                      # Set LEDs to heating-mode
#   #   M106 S255                                           # Turn on the PT-fan

#   #   ##  Uncomment if you have a Nevermore.
#   #   #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

#   #   G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#     M190 S{target_bed}                                  # Set the target temp for the bed
#   #   SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"  # Display info on display
#   #   TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber temp

#   # # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
#   # {% else %}
#   #   SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
#   #   STATUS_HEATING                                      # Set LEDs to heating-mode
#   #   G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#   #   M190 S{target_bed}                                  # Set the target temp for the bed
#   #   SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
#   #   G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
#   # {% endif %}

#   # Heat hotend to 150c. This helps with getting a correct Z-home.
#   SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
#   M109 S150                                             # Heat hotend to 150c

#   ##  Uncomment for Beacon contact (2 of 4 for beacon contact)
#   #G28 Z METHOD=CONTACT CALIBRATE=1                     # Calibrate z offset and beacon model

#   ##  Uncomment for Trident (Z_TILT_ADJUST)
#   #SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
#   #STATUS_LEVELING                                      # Set LEDs to leveling-mode
#   #Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
#   #G28 Z                                                # Home Z again after Z_TILT_ADJUST

#   ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
#   SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
#   STATUS_LEVELING                                      # Set LEDs to leveling-mode
#   QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
#   G28 Z                                                # Home Z again after QGL

#   ##  Uncomment for bed mesh (2 of 2 for bed mesh)
#   SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
#   STATUS_MESHING                                       # Set LEDs to bed mesh-mode
#   BED_MESH_CALIBRATE                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

#   ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
#   #G28 Z METHOD=CONTACT CALIBRATE=0                     # Calibrate z offset only with hot nozzle

#   # Heat up the hotend up to target via data from slicer
#   SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
#   STATUS_HEATING                                        # Set LEDs to heating-mode
#   G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
#   M107                                                  # Turn off partcooling fan
#   M109 S{target_extruder}                               # Heat the hotend to set temp

#   ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
#   #SET_GCODE_OFFSET Z=0.06                              # Add a little offset for hotend thermal expansion

#   # Get ready to print by doing a primeline and updating the LEDs
#   SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
#   STATUS_PRINTING                                       # Set LEDs to printing-mode
#   G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
#   G0 Z0.4                                               # Raise Z to 0.4
#   G91                                                   # Incremental positioning 
#   G1 X100 E20 F1000                                     # Primeline
#   G90                                                   # Absolute position


# [gcode_macro PRINT_END]
# #   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
# gcode:
#     SAVE_GCODE_STATE NAME=STATE_PRINT_END

#     M400                           ; wait for buffer to clear
#     G92 E0                         ; zero the extruder
#     G1 E-10.0 F3600                ; retract filament

#     G91                            ; relative positioning
#     G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
#     TURN_OFF_HEATERS
#     M107                           ; turn off fan
#     G1 Z30 F3000                    ; move nozzle up 30mm
#     G90                            ; absolute positioning
#     G0  X125 Y250 F3600            ; park nozzle at rear
#     BED_MESH_CLEAR
#     # M84 E                          ; turn off extruder motor
#     SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    
#     # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
#     # command pair is to restore the printer's coordinate system
#     # and speed settings since the commands above change them.
#     # However, to prevent any accidental, unintentional toolhead
#     # moves when restoring the state, explicitly set MOVE=0.
#     RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0



#https://klipperscreen.readthedocs.io/en/latest/macros/#load_filament-unload_filament
[gcode_macro LOAD_FILAMENT]
variable_load_distance:  70
variable_purge_distance:  30
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  70
variable_purge_distance:  10
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed} # purge
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro M600]
description: Filament change
gcode: 
    _CHOME
    {% set vars = printer["gcode_macro _KOMB_Variables"] %}
    {% set purge_x = params.PURGE_LOCATION_X|default(vars.purge_location_x)|float %}
    {% set purge_y = params.PURGE_LOCATION_Y|default(vars.purge_location_y)|float %}
    # {% set purge_z = params.PURGE_LOCATION_Z|default(vars.purge_location_z)|float %}
    PAUSE X=purge_x Y=purge_y Z_MIN=50
    KOMB






[gcode_macro PPPRINTSTART]
gcode:
    # Your existing PRINTSTART code here...
    
    # Show the heatsoak prompt
    _SHOW_HEATSOAK_PROMPT
    
    # Rest of your PRINTSTART code continues after prompt is handled

[gcode_macro _SHOW_HEATSOAK_PROMPT]
variable_heatsoak_requested: 0
gcode:
    # Reset the variable
    SET_GCODE_VARIABLE MACRO=_SHOW_HEATSOAK_PROMPT VARIABLE=heatsoak_requested VALUE=0
    
    # Create the prompt with Yes/No buttons
    RESPOND TYPE=command MSG="action:prompt_begin Heatsoak?"
    RESPOND TYPE=command MSG="action:prompt_text Do you want to run heatsoak?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_HEATSOAK_YES|primary"
    RESPOND TYPE=command MSG="action:prompt_button No|_HEATSOAK_NO|secondary"
    RESPOND TYPE=command MSG="action:prompt_show"
    
    # Schedule automatic timeout/close after 10 seconds
    UPDATE_DELAYED_GCODE ID=_HEATSOAK_PROMPT_TIMEOUT DURATION=10

[gcode_macro _HEATSOAK_YES]
gcode:
    # User clicked Yes - cancel the timeout and run heatsoak
    UPDATE_DELAYED_GCODE ID=_HEATSOAK_PROMPT_TIMEOUT DURATION=0
    SET_GCODE_VARIABLE MACRO=_SHOW_HEATSOAK_PROMPT VARIABLE=heatsoak_requested VALUE=1
    RESPOND TYPE=command MSG="action:prompt_end"
    HEATSOAK

[gcode_macro _HEATSOAK_NO]
gcode:
    # User clicked No - cancel the timeout and continue
    UPDATE_DELAYED_GCODE ID=_HEATSOAK_PROMPT_TIMEOUT DURATION=0
    RESPOND TYPE=command MSG="action:prompt_end"
    # PRINTSTART continues normally

[delayed_gcode _HEATSOAK_PROMPT_TIMEOUT]
gcode:
    # Timeout expired - close the prompt and continue without heatsoak
    RESPOND TYPE=command MSG="action:prompt_end"
    # PRINTSTART continues normally (no heatsoak)
